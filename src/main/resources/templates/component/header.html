<header id="header" role="banner" th:fragment="siteHeader" xmlns:th="http://www.w3.org/1999/xhtml">
    <div class="container fluid">
        <div class="accessibility-box" aria-label="접근성 및 보기 설정">
            <div class="text-size" role="group" aria-label="화면 크기 조절">
                <span id="txtSizeLabel">화면 크기</span>
                <button type="button" class="btn-text-plus" aria-labelledby="txtSizeLabel" aria-controls="pageRoot" aria-describedby="txtSizeStatus">
                    <i class="icon icon-plus" aria-hidden="true"></i><span class="blind">화면 크게</span>
                </button>
                <button type="button" class="btn-text-minus" aria-labelledby="txtSizeLabel" aria-controls="pageRoot" aria-describedby="txtSizeStatus">
                    <i class="icon icon-minus" aria-hidden="true"></i><span class="blind">화면 작게</span>
                </button>
                <span id="txtSizeStatus" class="blind" aria-live="polite"></span>
            </div>
            <div class="theme-box" role="group" aria-label="테마 전환">
                <span id="themeLabel">고대비</span>
                <button type="button"
                        class="btn-contrast"
                        aria-labelledby="themeLabel"
                        aria-pressed="false"
                        aria-describedby="themeStatus">
                    OFF
                    <span class="blind">고대비 모드 토글</span>
                </button>
                <span id="themeStatus" class="blind" aria-live="polite"></span>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="header-inner">
            <h1>
                <a th:href="@{/}" aria-label="홈으로 이동"></a>
            </h1>

            <!-- GNB -->
            <nav id="gnb1" aria-label="주요 메뉴">
                <ul class="gnb-list" role="menubar">
                    <li role="none" class="has-sub">
                        <button type="button" role="menuitem" aria-haspopup="true" aria-expanded="false" aria-controls="sub-plat">플랫폼소개</button>
                        <div id="sub-plat" class="depth-box" role="group">
                            <div class="depth-inner">
                                <a role="menuitem" th:href="@{/intro/intro}" class="swap-link">플랫폼소개</a>
                                <a role="menuitem" th:href="@{/intro/model}" class="swap-link">모델별별</a>
                                <a role="menuitem" th:href="@{/intro/business}" class="swap-link">사업제휴문의</a>
                            </div>
                        </div>
                    </li>

                    <li role="none" class="has-sub">
                        <button type="button" role="menuitem" aria-haspopup="true" aria-expanded="false" aria-controls="sub-svc">서비스안내</button>
                        <div id="sub-svc" class="depth-box" role="group">
                            <div class="depth-inner">
                                <a role="menuitem" th:href="@{/service/service}" class="swap-link">서비스안내1</a>
                                <a role="menuitem" href="" class="swap-link">서비스안내2</a>
                                <a role="menuitem" href="" class="swap-link">서비스안내3</a>
                                <a role="menuitem" href="" class="swap-link">서비스안내4</a>
                            </div>
                        </div>
                    </li>

                    <li role="none" class="has-sub">
                        <button type="button" role="menuitem" aria-haspopup="true" aria-expanded="false" aria-controls="sub-guide">이용안내</button>
                        <div id="sub-guide" class="depth-box" role="group">
                            <div class="depth-inner">
                                <a role="menuitem" th:href="@{/guide/guide_join}" class="swap-link">회원가입안내</a>
                                <a role="menuitem" th:href="@{/guide/guide_subsidy}" class="swap-link">지원금 신청 및 지급안내</a>
                            </div>
                        </div>
                    </li>

                    <li role="none" class="has-sub">
                        <button type="button" role="menuitem" aria-haspopup="true" aria-expanded="false" aria-controls="sub-news">소식</button>
                        <div id="sub-news" class="depth-box" role="group">
                            <div class="depth-inner">
                                <a role="menuitem" th:href="@{/notice/boardDetail}" class="swap-link">공지사항상세</a>
                                <a role="menuitem" th:href="@{/notice/boardList}" class="swap-link">공지사항목록</a>
                            </div>
                        </div>
                    </li>
                </ul>
            </nav>

            <div class="gnb">
                <div class="util-box" aria-label="사용자 메뉴">
                    <a th:href="@{/login}" class="swap-link">로그인</a>
                    <span aria-hidden="true"></span>
                    <a th:href="@{/join/step1}" class="swap-link">회원가입</a>
                </div>
                <button type="button" class="btn-menu" aria-controls="sitemap" aria-expanded="false" aria-label="사이트맵 열기">
                    <div aria-hidden="true"></div><div aria-hidden="true"></div><div aria-hidden="true"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="sitemap" class="sitemap" role="navigation" aria-label="사이트맵">
        <div class="container">
            <ul>
                <li>
                    <p>Brand</p>
                    <ul class="depth2">
                        <li><a href="" class="swap-link">Tmoney 스토리</a></li>
                        <li><a href="" class="swap-link">인사말</a></li>
                        <li><a href="" class="swap-link">연혁</a></li>
                        <li><a href="" class="swap-link">비전/핵심가치</a></li>
                        <li><a href="" class="swap-link">오시는 길</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</header>

<script>
    let listAbort;

    async function reloadContent(url) {
        listAbort?.abort();
        listAbort = new AbortController();
        const signal = listAbort.signal;

        try {
            const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' }, signal });
            const html = await res.text();

            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newContent = doc.querySelector('#contents');
            if (!newContent) return;

            const contents = document.querySelector('#contents');
            contents.replaceChildren(...newContent.childNodes);

            if (window.AOS) AOS.refreshHard();
            if (window.initSwiper) window.initSwiper();

            window.history.pushState({}, '', url);

        } catch (err) {
            if (err.name === 'AbortError') return;
            console.error('컨텐츠 로드 실패', err);
        }
    }

    // swap-link 클릭 처리
    document.body.addEventListener('click', e => {
        const link = e.target.closest('.swap-link');
        if (!link) return;
        e.preventDefault();
        reloadContent(link.href);
    });

    // popstate 처리
    window.addEventListener('popstate', () => {
        reloadContent(location.href);
    });
</script>
